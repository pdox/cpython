diff --git a/jit/jit-alloc.c b/jit/jit-alloc.c
index a96620b..9411952 100644
--- a/jit/jit-alloc.c
+++ b/jit/jit-alloc.c
@@ -81,7 +81,7 @@ _jit_malloc_exec(unsigned int size)
 #elif defined(JIT_USE_MMAP)
 	void *ptr = mmap(0, size,
 			 PROT_READ | PROT_WRITE | PROT_EXEC,
-			 MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
+			 MAP_PRIVATE | MAP_ANONYMOUS | MAP_32BIT, -1, 0);
 	if(ptr == (void *)-1)
 	{
 		return (void *)0;
diff --git a/jit/jit-compile.c b/jit/jit-compile.c
index ba310e4..7b34514 100644
--- a/jit/jit-compile.c
+++ b/jit/jit-compile.c
@@ -308,6 +308,7 @@ reset_value(jit_value_t value)
 	value->reg = -1;
 	value->in_register = 0;
 	value->in_global_register = 0;
+	value->has_global_register = 0;
 	value->in_frame = 0;
 }
 
@@ -743,6 +744,9 @@ compile(_jit_compile_t *state, jit_function_t func)
 		/* Clean up the compilation state */
 		cleanup_on_restart(&state->gen, state->func);
 
+		/* Prepare data needed for code generation */
+		codegen_prepare(state);
+
 		/* Allocate more space */
 		memory_realloc(state);
 	}
